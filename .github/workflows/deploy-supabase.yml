# name: Deploy Supabase Migrations

# on:
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     env:
#       SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
#       SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - name: Install dependencies
#         run: npm ci

#       - name: Setup Supabase CLI
#         uses: supabase/setup-cli@v1
#         with:
#           version: latest

#       - name: Verify Supabase CLI installation
#         run: supabase --version

#       - name: Link Supabase project
#         run: supabase link --project-ref $SUPABASE_PROJECT_REF

#       - name: Run database migrations (PR only)
#         if: github.event_name == 'pull_request'
#         run: |
#           echo "Checking migrations for pull request..."
#           supabase db diff --linked --schema public

#       - name: Deploy to production (main branch only)
#         if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#         run: |
#           echo "Deploying migrations to production..."
#           supabase db push --linked
          
#       - name: Generate and commit types (main branch only)
#         if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#         run: |
#           echo "Generating TypeScript types..."
#           mkdir -p lib
#           supabase gen types typescript --linked > lib/database.types.ts
          
#           # Check if there are changes to commit
#           if [[ -n $(git status --porcelain) ]]; then
#             git config --local user.email "action@github.com"
#             git config --local user.name "GitHub Action"
#             git add lib/database.types.ts
#             git commit -m "Update database types [skip ci]"
#             git push
#           else
#             echo "No changes to database types"
#           fi

#       - name: Notify deployment status
#         if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#         run: |
#           echo "âœ… Successfully deployed migrations to production"
#           echo "ðŸ“Š Database schema is now up to date"
          
#   # Optional: Run tests after migration
#   test:
#     needs: deploy
#     runs-on: ubuntu-latest
#     if: github.event_name == 'pull_request'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - name: Install dependencies
#         run: npm ci

#       - name: Run tests
#         run: |
#           echo "Running tests..."
#           # Add your test commands here
#           # npm test